<!DOCTYPE html>
<html>
    <head>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"/>
        <meta charset="UTF-8">
        <meta name="theme-color" content="#4b75ff">
        <link rel="stylesheet" href="../script/semantic/semantic.min.css">
        <script src="../script/jquery.min.js"></script>
        <script src="../script/ao_module.js"></script>
        <script src="../script/semantic/semantic.min.js"></script>
        <title>TorrentA</title>
        <style>
            body{
                background-color:white;
            }

            /*
                Theme Color
                #E3170A red
                #70ABAF green
                #FCF6B1 yellow
                #5ADBFF Blue
                #414288 purple
                #2D1E2F dark purple
            */

            .downloadTask{
                cursor: pointer;
            }

            .downloadTask:hover{
                background-color: #e8e8e8;
            }

            .downloadTask.selected{
                background-color: #e1eafa;
            }

            .downloadTask.completed{
                background-color: #bcffb0;
            }
        </style>
    </head>
    <body>
        <div class="ui labeled icon small menu">
            <a class="item" onclick="newJob();">
                <i class="add icon"></i>
                New Job
            </a>
           
            <a class="item" style="color: #70ABAF;">
                <i class="play icon"></i>
                Start All
            </a>
            <a class="item">
                <i class="square icon"></i>
                Stop All
            </a>
        </div>
        <div class="ui grid">
            <div class="three wide column">
                <div class="ui vertical left attached basic fluid buttons">
                    <button class="ui button"><i class="file icon"></i> All Torrents</button>
                    <button class="ui button"><i class="download icon"></i> Downloading</button>
                    <button class="ui button"><i class="upload icon"></i> Seeding</button>
                    <button class="ui button"><i class="checkmark icon"></i> Completed</button>
                </div>
                <div class="ui container" style="padding: 12px;">
                    Powered by <a href="https://github.com/aroz-online/TorrentA" target="_blank">TorrentA</a> and <a href="https://github.com/anacrolix/torrent" target="_blank">torrent</a>
                </div>
                
            </div>
            <div class="thirteen wide column">
                <div class="ui basic segment">
                    <p>The table below only shows download tasks initiated by you. The host system bandwidth is shared among other users (if any).</p>
                    <table class="ui basic unstackable celled table">
                        <thead>
                            <tr><th>Status</th>
                            <th>Torrent Name</th>
                            <th>Size</th>
                            <th>Progress</th>
                            <th>Files</th>
                            <th>Actions</th>
                        </tr></thead>
                        <tbody id="ongoingTaskList">
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add job confirmation -->
        <div id="newjob" class="ui modal">
            <i class="close icon"></i>
            <div class="header">
                Add New Job
            </div>
            <div class="content">
                <div class="description">
                <p>Add Job by Torrent File</p>
                <div class="ui action fluid input">
                    <input type="text" id="targetTorrentFile" placeholder="user:/Desktop/myfile.torrent">
                    <button class="ui button" onclick="selectTorrentFile();"><i class="folder open icon"></i> Open</button>
                </div>
                <div class="ui divider"></div>
                <p>Or Add Job by Magnet Link</p>
                <div class="ui left icon fluid input">
                    <input type="text" id="magnetLink" placeholder="magnet:?">
                    <i style="transform: rotate(90deg);" class="magnet icon"></i>
                </div>
                </div>
            </div>
            <div class="actions">
                
                <div class="ui positive left labeled icon button" onclick="confirmAddJob();">
                <i class="checkmark icon"></i>
                OK
                </div>
                <div class="ui black deny button">
                Cancel
                </div>
            </div>
        </div>
        <script>
            var flist = ao_module_loadInputFiles();
            if (flist == null){
                
            }else{
               
            }

            $(document).ready(function(){
                //Stsart the torrent downloader client for this user
                $.get("./init", function(data){
                    
                });

                //Initialize the list
                listAllTorrents();
                setInterval(function(){
                    listAllTorrents();
                }, 5000);
            });

            function bindTableEvent(){
                /*
                $(".downloadTask").off("click").on("click", function(e){
                    $(this).addClass("selected");
                });
                */
            }

            function newJob(){
                $("#newjob").modal('show');
            }

            function selectTorrentFile(){
                ao_module_openFileSelector(torrentFileSelected, "user:/Desktop", "file", true, {
                    filter: ["torrent"]
                });
            }

           function confirmAddJob(){
               var torrentFile = $("#targetTorrentFile").val();
               var magnet = $("#magnetLink").val();

               if (magnet != ""){
                   //use magnet

               }else{
                   //Use torrent file
                    $.ajax({
                        url: "torrent/addTorrent",
                        data: {file: torrentFile},
                        success: function(data){
                            
                        }
                    })
               }
           }

         

            function startThis(btn){
                var hash = $(btn).attr("hash");
                startSelectedTorrents(hash);
            }

            function stopThis(btn){
                var hash = $(btn).attr("hash");
                stopSelectedTorrents(hash);
            }

            function dropThis(btn){
                var hash = $(btn).attr("hash");
                dropSelectedTorrent(hash);
            }

            function startSelectedTorrents(hash){
                $.ajax({
                    url: "torrent/startTorrent",
                    data: {hash: hash},
                    success: function(data){
                        console.log(data);
                    }
                });
            }

            function stopSelectedTorrents(hash){
                $.ajax({
                    url: "torrent/stopTorrent",
                    data: {hash: hash},
                    success: function(data){
                        console.log(data);
                    }
                });
            }

            function dropSelectedTorrent(hash){
                if (confirm("Confirm dropping torrent? The downloaded files will be intact.")){
                    $.ajax({
                        url: "torrent/dropTorrent",
                        data: {hash: hash},
                        success: function(data){
                            console.log(data);
                        }
                    });
                }
            }

            function bytesToSize(bytes) {
                var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                if (bytes == 0) return '0 Byte';
                var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
            }

           function listAllTorrents(){
               $.ajax({
                   url: "torrent/list",
                   success: function(data){
                        $("#ongoingTaskList").html("");
                        if (data.error !== undefined){
                            //Maybe backend restarted. Restart connection
                            $.get("./init", function(data){
                                
                            });
                            return
                        }
                        console.log(data);
                        data.forEach(download => {
                            //Estimate the whole download size
                            var totalSize = 0;
                            download.Info.Files.forEach(file => {
                                totalSize += file.Length;
                            })

                            //Estimate the progress of the download
                            var progress = download.Progress.toFixed(1) + "%";

                            var icon = "blue download";
                            var colorClass = "";
                            if (download.Progress == 100){
                                icon = "green checkmark";
                                colorClass = "completed"
                            }

                            $("#ongoingTaskList").append(`<tr class="downloadTask ${colorClass}" hash="${download.Hash}">
                                <td><i class="${icon} icon"></i></td>
                                <td>${download.Name}</td>
                                <td>${bytesToSize(totalSize)}</td>
                                <td>${progress}</td>
                                <td>${download.Info.Files.length}</td>
                                <td>
                                    <div class="ui icon mini buttons">
                                        <button  hash="${download.Hash}" class="ui basic button" onclick="startThis(this);"><i class="green play icon"></i></button>
                                        <button  hash="${download.Hash}" class="ui basic button" onclick="stopThis(this);"><i class="orange pause icon"></i></button>
                                        <button  hash="${download.Hash}" class="ui basic button"><i class="blue info icon"></i></button>
                                        <button  hash="${download.Hash}" class="ui red button" onclick="dropThis(this);"><i class="trash icon"></i></button>
                                    </div></td>
                            </tr>`);
                        });

                        //Bind events on the task
                        bindTableEvent();
                   }
               })
           }

            function torrentFileSelected(filedata){
                for (var i=0; i < filedata.length; i++){
                    var filename = filedata[i].filename;
                    var filepath = filedata[i].filepath;
                    $("#targetTorrentFile").val(filepath);
                }
            }
        </script>
    </body>
</html>